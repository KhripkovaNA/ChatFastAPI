# Проект: Мини-чат на FastAPI

Данный проект представляет собой веб-приложение для обмена сообщениями в реальном времени, построенное с использованием **FastAPI**, **SQLAlchemy 2.0** с поддержкой асинхронного подключения для работы с базой данных и **WebSocket** для мгновенной доставки сообщений. Проект также включает интеграцию с **Redis** для кеширования и **Celery** для асинхронного выполнения задач, а также Telegram-уведомления.

## Стек технологий:
- **Backend**: FastAPI
- **Frontend**: HTML, JavaScript, CSS
- **ORM**: SQLAlchemy 2.0 (асинхронное подключение)
- **База данных**: PostgreSQL
- **Кеширование**: Redis
- **Очередь задач**: Celery
- **Docker**: Для контейнеризации приложения
- **Telegram Bot**: Aiogram для отправки уведомлений о новых сообщениях через Telegram

## Основные компоненты:
1. **Модель пользователя**: Содержит информацию о пользователях, включая имя, email, пароль, Telegram ID и роль (например, `user` или `admin`). При регистрации или входе через Telegram аккаунт пользователя привязывается к Telegram ID для отправки уведомлений.
2. **Модель сообщений**: Сохраняет текстовые сообщения, отправленные пользователями, включая отправителя, получателя, время отправки и статус прочтения.

## Функционал:

1. **Аутентификация**: Регистрация и авторизация пользователей через HTML-формы с поддержкой JWT токенов и возможностью входа через Telegram.
2. **Чат**: Пользователи могут отправлять и получать сообщения с мгновенной доставкой. История сообщений загружается при помощи серверного опроса.
3. **WebSocket**: Для мгновенной отправки сообщений, поддержания актуального состояния чата и моментальной доставки.
4. **Кеширование с Redis**: Используется для кеширования данных пользователей, что снижает нагрузку на базу данных.
5. **Очереди задач с Celery**: Используется для асинхронной отправки сообщений и других фоновых задач.
6. **Уведомления в Telegram**: Если пользователь не в сети, при новом сообщении он получит уведомление в Telegram. Интеграция с ботом позволяет получать такие уведомления автоматически.
7. **Панель администратора**: Реализована с использованием SQLAdmin, позволяет управлять пользователями и сообщениями.

## Установка и запуск проекта

Для настройки проекта необходимо создать файл `.env` и указать в нем следующие переменные окружения:

### Основные переменные

- `SECRET_KEY=` — секретный ключ для приложения (используется для токенов и шифрования).
- `ALGORITHM=` — алгоритм шифрования (например, HS256).

### Настройки базы данных PostgreSQL

- `DB_HOST=` — хост для подключения к базе данных (например, `localhost` для локальной разработки или `db` для Docker).
- `DB_PORT=` — порт для подключения к базе данных (обычно `5432`).
- `DB_NAME=` — имя базы данных.
- `DB_USER=` — пользователь базы данных.
- `DB_PASS=` — пароль пользователя базы данных.

### Настройки Redis

- `REDIS_HOST=` — хост для подключения к Redis (например, `localhost` или `redis` для Docker).
- `REDIS_PORT=` — порт для подключения к Redis (обычно `6379`).

### Дополнительные настройки PostgreSQL для Docker

При использовании Docker Compose:

- `POSTGRES_DB=` — имя базы данных.
- `POSTGRES_USER=` — пользователь базы данных.
- `POSTGRES_PASSWORD=` — пароль пользователя базы данных.

### Параметры администратора

- `ADMIN_EMAIL=` — электронная почта для администратора.
- `ADMIN_PASSWORD=` — пароль администратора.

### Настройки Telegram

- `bot_token=` — токен для Telegram-бота.
- `base_webhook_url=` — URL для вебхука Telegram-бота.
- `telegram_my_token=` — личный токен для взаимодействия с Telegram API.

## Запуск проекта

### 1. Клонирование репозитория
```bash
git clone https://github.com/KhripkovaNA/ChatFastAPI.git
cd ChatFastAPI
```

### 2. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 3. Выполнение миграций Alembic
```bash
alembic upgrade head
```

### 4. Запуск проекта
```bash
uvicorn app.main:app --reload
```

### 5. Запуск Celery

Для запуска Celery-воркера с подключением к Redis выполните:

```bash
celery -A app.tasks.core:celery worker --loglevel=INFO
```

## Контейнеризация с Docker

Проект имеет `Dockerfile` и `docker-compose.yml`. 

### Конфигурация .env для Docker

При развертывании проекта в Docker необходимо указать следующие значения:

- `DB_HOST=db`
- `DB_PORT=5432`
- `REDIS_HOST=redis`
- `REDIS_PORT=6379`

### Запуск

```bash
docker-compose up --build
```
